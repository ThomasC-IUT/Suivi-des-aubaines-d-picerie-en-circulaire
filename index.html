<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi des aubaines d'√©picerie en circulaire</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        :root {
            --color-cream-50: rgba(252, 252, 249, 1);
            --color-cream-100: rgba(255, 255, 253, 1);
            --color-gray-200: rgba(245, 245, 245, 1);
            --color-gray-300: rgba(167, 169, 169, 1);
            --color-slate-500: rgba(98, 108, 113, 1);
            --color-brown-600: rgba(94, 82, 64, 1);
            --color-charcoal-700: rgba(31, 33, 33, 1);
            --color-charcoal-800: rgba(38, 40, 40, 1);
            --color-slate-900: rgba(19, 52, 59, 1);
            --color-teal-300: rgba(50, 184, 198, 1);
            --color-teal-500: rgba(33, 128, 141, 1);
            --color-teal-600: rgba(29, 116, 128, 1);
            --color-teal-700: rgba(26, 104, 115, 1);
            --color-brown-600-rgb: 94, 82, 64;
            --color-teal-500-rgb: 33, 128, 141;
            --color-slate-900-rgb: 19, 52, 59;
            --color-background: var(--color-cream-50);
            --color-surface: var(--color-cream-100);
            --color-text: var(--color-slate-900);
            --color-text-secondary: var(--color-slate-500);
            --color-primary: var(--color-teal-500);
            --color-primary-hover: var(--color-teal-600);
            --color-primary-active: var(--color-teal-700);
            --color-border: rgba(var(--color-brown-600-rgb), 0.2);
            --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
            --font-family-base: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --font-size-sm: 12px;
            --font-size-base: 14px;
            --font-size-lg: 16px;
            --font-size-xl: 18px;
            --font-size-2xl: 20px;
            --font-size-3xl: 24px;
            --space-8: 8px;
            --space-12: 12px;
            --space-16: 16px;
            --space-20: 20px;
            --space-24: 24px;
            --radius-base: 8px;
            --radius-lg: 12px;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --color-gray-400-rgb: 119, 124, 124;
                --color-teal-300-rgb: 50, 184, 198;
                --color-gray-200-rgb: 245, 245, 245;
                --color-background: var(--color-charcoal-700);
                --color-surface: var(--color-charcoal-800);
                --color-text: var(--color-gray-200);
                --color-text-secondary: rgba(var(--color-gray-300), 0.7);
                --color-primary: var(--color-teal-300);
                --color-border: rgba(var(--color-gray-400-rgb), 0.3);
                --color-card-border: rgba(var(--color-gray-400-rgb), 0.2);
            }
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: var(--font-family-base);
            background-color: var(--color-background);
            color: var(--color-text);
            line-height: 1.5;
            display: flex;
            flex-direction: row; /* Changed to row for sidebar layout */
            height: 100vh; /* Fixed height for scrolling areas */
            overflow: hidden;
        }

        /* Content Wrapper (Main + Footer) */
        .content-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            height: 100%;
        }

        /* Header (Sidebar) */
        header {
            background-color: var(--color-surface);
            border-right: 1px solid var(--color-border); /* Changed from border-bottom */
            border-bottom: none;
            padding: var(--space-24);
            box-shadow: var(--shadow-sm);
            width: 300px; /* Fixed width sidebar */
            height: 100vh;
            flex-shrink: 0;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            z-index: 100;
        }
        
        .header-container { 
            /* Removed max-width, adapted for column */
            display: flex; 
            flex-direction: column; 
            gap: var(--space-24);
            align-items: flex-start; 
            width: 100%;
        }
        
        .logo { margin-bottom: var(--space-16); }
        .logo h1 { font-size: var(--font-size-2xl); color: var(--color-primary); font-weight: 600; line-height: 1.2; }
        .logo p { font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-top: 4px; }
        
        nav { width: 100%; }
        nav ul { 
            list-style: none; 
            display: flex; 
            flex-direction: column; /* Vertical links */
            gap: var(--space-12); 
            width: 100%;
        }
        nav a { 
            color: var(--color-text); 
            text-decoration: none; 
            font-size: var(--font-size-lg); 
            transition: color 0.2s; 
            display: block;
            padding: 8px 0;
        }
        nav a:hover { color: var(--color-primary); transform: translateX(4px); }
        
        .cart-btn { 
            display:flex; 
            align-items:center; 
            justify-content: space-between;
            gap:8px; 
            background:var(--color-primary); 
            color:#fff; 
            border:none; 
            padding:10px 16px; 
            border-radius:var(--radius-base); 
            cursor:pointer; 
            font-weight:600; 
            font-size: var(--font-size-base); 
            width: 100%; /* Full width button */
        }
        .cart-btn:hover{ background: var(--color-primary-hover); }

        /* Sidebar Filter Section */
        .sidebar-filter {
            margin-top: var(--space-24);
            padding-top: var(--space-24);
            border-top: 1px solid var(--color-border);
            width: 100%;
        }
        .sidebar-filter h3 {
            font-size: var(--font-size-base);
            font-weight: 600;
            margin-bottom: var(--space-12);
            color: var(--color-text);
        }

        /* Main */
        main { 
            max-width: 1400px; 
            margin: 0 auto; 
            padding: var(--space-24); 
            width: 100%;
            flex: 1; 
        }
        
        /* Modified filters container since store is gone */
        .filters { 
            background: var(--color-surface); 
            padding: var(--space-16); 
            border-radius: var(--radius-lg); 
            border: 1px solid var(--color-card-border); 
            margin-bottom: var(--space-24); 
            display:flex; 
            gap: var(--space-16); 
            flex-wrap: wrap; 
            align-items: end; 
        }
        .filter-group { flex:1; min-width: 180px; }
        .filter-group label { display:block; margin-bottom: var(--space-8); font-weight: 500; font-size: var(--font-size-sm); }
        .filter-group select, .filter-group input[type="text"] { width:100%; padding: var(--space-8) var(--space-12); border:1px solid var(--color-border); border-radius: var(--radius-base); background: var(--color-background); color: var(--color-text); font-size: var(--font-size-base); }
        .items-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(280px,1fr)); gap: var(--space-20); }

        /* Nav Subsection - Store list nested under Accueil */
        .nav-subsection {
            margin-top: var(--space-8);
            margin-left: var(--space-12);
            padding-left: var(--space-12);
            border-left: 2px solid var(--color-border);
        }
        .nav-subsection .store-list {
            max-height: 300px;
            overflow-y: auto;
            padding: var(--space-8) 0;
        }
        .store-checkbox-label{ display:flex; align-items:center; gap: var(--space-8); padding:4px 0; cursor:pointer; font-size: var(--font-size-sm); user-select:none; }
        .store-checkbox-label input{ accent-color: var(--color-primary); width:14px; height:14px; }

        /* Cards */
        .item-card { background: var(--color-surface); border:1px solid var(--color-card-border); border-radius: var(--radius-lg); padding: var(--space-16); box-shadow: var(--shadow-sm); transition: transform 0.2s, box-shadow 0.2s; position: relative; }
        .item-card:hover{ transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .item-header{ display:flex; justify-content: space-between; align-items:start; margin-bottom: var(--space-12); }
        .item-name{ font-size: var(--font-size-lg); font-weight: 600; color: var(--color-text); padding-right: 24px; }
        .item-category{ background: var(--color-primary); color:#fff; padding: 4px 8px; border-radius:4px; font-size: var(--font-size-sm); }
        .item-details{ margin: var(--space-12) 0; }
        .detail-row{ display:flex; justify-content: space-between; margin-bottom: var(--space-8); font-size: var(--font-size-sm); }
        .detail-label{ color: var(--color-text-secondary); }
        .detail-value{ font-weight: 500; }
        .item-price{ font-size: var(--font-size-xl); font-weight: 600; color: var(--color-primary); margin: var(--space-12) 0; }
        .item-store{ display:flex; justify-content: space-between; align-items:center; padding-top: var(--space-12); border-top:1px solid var(--color-border); }
        .store-name{ font-weight:500; }
        .item-date{ font-size: var(--font-size-sm); color: var(--color-text-secondary); }
        .add-to-list-btn{ position:absolute; top: var(--space-16); right: var(--space-16); background: var(--color-surface); border:1px solid var(--color-border); width:32px; height:32px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; color: var(--color-text); font-size:18px; transition: all 0.2s; z-index:2; }
        .add-to-list-btn:hover{ background: var(--color-primary); color:#fff; border-color: var(--color-primary); }

        .loading{ text-align:center; padding: var(--space-24); font-size: var(--font-size-lg); color: var(--color-text-secondary); }
        .error{ background: rgba(192,21,47,0.1); border:1px solid rgba(192,21,47,0.3); color:#c0152f; padding: var(--space-16); border-radius: var(--radius-base); margin-bottom: var(--space-24); }

        /* Deal Badge */
        .deal-badge{ display:inline-block; padding:2px 8px; border-radius:9999px; font-size: var(--font-size-sm); font-weight:600; line-height:1.4; }
        .badge-best{ background: linear-gradient(90deg,#ff6a3d,#ff3d3d); color:#fff; }
        .badge-excellent{ background: rgba(16,185,129,0.15); color:#10b981; border:1px solid rgba(16,185,129,0.35); }
        .badge-good{ background: rgba(59,130,246,0.12); color:#1d4ed8; border:1px solid rgba(29,78,216,0.25); }
        .badge-regular{ background: rgba(107,114,128,0.12); color:#6b7280; border:1px solid rgba(107,114,128,0.25); }
        .deal-insights{ margin-top:6px; }
        .deal-line{ font-size: var(--font-size-sm); color: var(--color-text-secondary); }

        /* Modal base */
        .modal-overlay{ position:fixed; inset:0; background: rgba(0,0,0,0.5); display:flex; justify-content:center; align-items:center; z-index:1000; opacity:0; pointer-events:none; transition: opacity 0.3s ease; }
        .modal-overlay.open{ opacity:1; pointer-events: all; }
        .modal-content{ background: var(--color-surface); border-radius: var(--radius-lg); width:90%; max-width:800px; max-height:90vh; padding: var(--space-24); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); display:flex; flex-direction:column; position:relative; }
        .close-modal{ position:absolute; top: var(--space-16); right: var(--space-16); background:none; border:none; font-size: var(--font-size-2xl); color: var(--color-text-secondary); cursor:pointer; z-index:10; }
        .close-modal:hover{ color: var(--color-text); }
        .chart-container{ position:relative; height:400px; width:100%; margin-top: var(--space-16); }
        .view-history-btn{ margin-top: var(--space-12); padding:6px 12px; background:transparent; border:1px solid var(--color-primary); color: var(--color-primary); border-radius: var(--radius-base); cursor:pointer; font-size: var(--font-size-sm); font-weight:500; display:inline-flex; align-items:center; gap:6px; transition: all 0.2s; width:100%; justify-content:center; }
        .view-history-btn:hover{ background: rgba(33,128,141,0.1); }

        /* Cart modal */
        .cart-modal-content{ max-width:600px; width:100%; display:flex; flex-direction:column; max-height:85vh; }
        .cart-header{ border-bottom:1px solid var(--color-border); padding-bottom: var(--space-16); margin-bottom: var(--space-16); }
        .budget-control{ display:flex; align-items:center; gap:10px; margin-top:10px; background: rgba(0,0,0,0.03); padding:8px; border-radius:6px; }
        .budget-control input{ width:100px; padding:4px 8px; border:1px solid var(--color-border); border-radius:4px; }
        .budget-alert{ color:#ef4444; font-size: var(--font-size-sm); font-weight:600; }
        .cart-items-container{ overflow-y:auto; flex:1; padding-right:8px; }
        .store-group{ margin-bottom: var(--space-24); }
        .store-group-title{ font-size: var(--font-size-lg); font-weight:600; color: var(--color-primary); margin-bottom: var(--space-8); padding-bottom:4px; border-bottom:2px solid rgba(0,0,0,0.05); }
        .category-group{ margin-left: var(--space-12); margin-bottom: var(--space-12); }
        .category-title{ font-size: var(--font-size-sm); font-weight:600; color: var(--color-text-secondary); text-transform: uppercase; letter-spacing: .05em; margin-bottom: 4px; }
        .cart-item{ display:flex; justify-content: space-between; align-items:center; padding:8px 0; border-bottom:1px solid var(--color-card-border); }
        .cart-item-info{ flex:1; }
        .cart-item-title{ font-weight:500; }
        .cart-item-meta{ font-size: var(--font-size-sm); color: var(--color-text-secondary); }
        .cart-item-actions{ display:flex; align-items:center; gap:12px; }
        .cart-price{ font-weight:600; }
        .remove-btn{ color:#ef4444; background:none; border:none; cursor:pointer; font-size:18px; padding:4px; }
        .cart-footer{ border-top:1px solid var(--color-border); padding-top: var(--space-16); margin-top: var(--space-16); }
        .cart-summary-row{ display:flex; justify-content: space-between; margin-bottom:4px; }
        .cart-total{ font-size: var(--font-size-xl); font-weight:700; color: var(--color-text); }
        .cart-savings{ color:#10b981; font-weight:500; }

        /* Footer */
        footer {
            padding: var(--space-24);
            border-top: 1px solid var(--color-border);
            background: var(--color-background);
        }

        @media (max-width: 850px){
            body { flex-direction: column; overflow: auto; height: auto; }
            .content-wrapper { height: auto; overflow: visible; }
            header { width: 100%; height: auto; border-right: none; border-bottom: 1px solid var(--color-border); position: relative; }
            .header-container { flex-direction: row; flex-wrap: wrap; align-items: center; justify-content: space-between; }
            nav { width: auto; }
            nav ul { flex-direction: row; }
            .sidebar-filter { width: 100%; margin-top: var(--space-12); padding-top: var(--space-12); }
            .logo { margin-bottom: 0; }
            
            .filters{ flex-direction:column; }
            .items-grid{ grid-template-columns: 1fr; }
            .footer-container{ flex-direction:column; text-align:center; }
            .footer-links ul{ flex-direction:column; gap: var(--space-8); }
        }
    </style>
</head>
<body>
    <!-- Vertical Sidebar -->
    <header>
        <div class="header-container">
            <div class="logo">
                <h1>üõí Aubaines √âpicerie</h1>
                <p>Suivi des circulaires du Qu√©bec</p>
            </div>
            <nav>
                <ul>
                    <li>
                        <a href="#accueil">Accueil</a>
                        <!-- Store Selector nested under Accueil -->
                        <div class="nav-subsection">
                            <div id="store-list-container" class="store-list"></div>
                        </div>
                    </li>
                    <li><a href="#aubaines">Aubaines</a></li>
                    <li><a href="#magasins">Magasins</a></li>
                    <li>
                        <button onclick="openCart()" class="cart-btn">
                            <span>üõí Ma Liste</span>
                            <span id="cart-count" style="background: rgba(255,255,255,0.2); padding:2px 6px; border-radius:10px; font-size: .8em;">0</span>
                        </button>
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Content Wrapper (Main + Footer) -->
    <div class="content-wrapper">
        <main>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: var(--space-24); flex-wrap:wrap; gap: var(--space-16);">
                <h2 id="week-title" style="margin:0; font-size: var(--font-size-3xl);">Aubaines en vedette</h2>
                <div style="display:flex; gap: var(--space-12); align-items:center;">
                    <button id="prev-week" style="padding:8px 16px; border:1px solid var(--color-border); border-radius: var(--radius-base); background: var(--color-surface); color: var(--color-text); cursor:pointer;">‚Üê Semaine pr√©c√©dente</button>
                    <select id="week-selector" style="padding:8px 12px; border:1px solid var(--color-border); border-radius: var(--radius-base); background: var(--color-surface); color: var(--color-text); min-width:200px;">
                        <option value="">Chargement...</option>
                    </select>
                    <button id="next-week" style="padding:8px 16px; border:1px solid var(--color-border); border-radius: var(--radius-base); background: var(--color-surface); color: var(--color-text); cursor:pointer;">Semaine suivante ‚Üí</button>
                </div>
            </div>

            <div class="filters">
                <!-- REMOVED STORE SELECTOR FROM HERE -->
                
                <div class="filter-group">
                    <label for="filter-category">Cat√©gorie</label>
                    <select id="filter-category">
                        <option value="">Toutes les cat√©gories</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filter-sort">Trier par</label>
                    <select id="filter-sort">
                        <option value="">D√©faut (R√©cents)</option>
                        <option value="price-asc">Prix (Croissant)</option>
                        <option value="price-desc">Prix (D√©croissant)</option>
                        <option value="unit-price-asc">Prix par quantit√© (Croissant)</option>
                        <option value="unit-price-desc">Prix par quantit√© (D√©croissant)</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filter-search">Recherche</label>
                    <input type="text" id="filter-search" placeholder="Rechercher un article ou une marque...">
                </div>
                <div class="filter-group" style="display:flex; align-items:center; gap:10px; min-width:180px;">
                    <label for="compact-mode" style="margin:0;">Mode compact</label>
                    <input type="checkbox" id="compact-mode" style="width:18px; height:18px;">
                </div>
            </div>

            <div id="error-message"></div>
            <div id="loading" class="loading">Chargement des aubaines...</div>
            <div id="items-container" class="items-grid"></div>
        </main>

        <footer>
            <div class="footer-container" style="max-width:1200px; margin:0 auto; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap: var(--space-16);">
                <div class="footer-info" style="flex:1;">
                    <h3 style="font-size: var(--font-size-lg); color: var(--color-primary);">Aubaines √âpicerie</h3>
                    <p style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">Votre source pour les meilleures aubaines d'√©picerie au Qu√©bec</p>
                    <p style="margin-top: var(--space-8); font-size: var(--font-size-sm); color: var(--color-text-secondary);">&copy; 2025 Aubaines √âpicerie. Tous droits r√©serv√©s.</p>
                </div>
                <div class="footer-links">
                    <ul style="list-style:none; display:flex; gap: var(--space-16);">
                        <li><a href="#a-propos">√Ä propos</a></li>
                        <li><a href="#confidentialite">Confidentialit√©</a></li>
                        <li><a href="#conditions">Conditions</a></li>
                        <li><a href="#contact">Contact</a></li>
                    </ul>
                </div>
            </div>
        </footer>
    </div>

    <!-- History Modal -->
    <div id="history-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-modal" onclick="closeHistoryModal()">&times;</button>
            <h3 id="modal-title" style="margin-bottom: var(--space-8); font-size: var(--font-size-xl); color: var(--color-primary);">Historique des prix</h3>
            <p id="modal-subtitle" style="color: var(--color-text-secondary); font-size: var(--font-size-sm); margin-bottom: var(--space-16);"></p>
            <div class="chart-container">
                <canvas id="priceChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Cart Modal -->
    <div id="cart-modal" class="modal-overlay">
        <div class="modal-content cart-modal-content">
            <button class="close-modal" onclick="closeCart()">&times;</button>
            <div class="cart-header">
                <h3 style="font-size: var(--font-size-xl); color: var(--color-primary);">Ma Liste d'√âpicerie</h3>
                <div class="budget-control">
                    <label for="cart-budget">Budget Max ($):</label>
                    <input type="number" id="cart-budget" value="100" onchange="updateCartDisplay()">
                    <span id="budget-warning" class="budget-alert" style="display:none;">‚ö†Ô∏è Budget d√©pass√© !</span>
                </div>
            </div>
            <div id="cart-items" class="cart-items-container">
                <p style="text-align:center; color: var(--color-text-secondary); margin-top:20px;">Votre liste est vide.</p>
            </div>
            <div class="cart-footer">
                <div class="cart-summary-row">
                    <span>√âconomies estim√©es (vs prix moyen) :</span>
                    <span id="cart-savings" class="cart-savings">0.00 $</span>
                </div>
                <div class="cart-summary-row">
                    <span style="font-size: var(--font-size-lg); font-weight:600;">Total estim√© :</span>
                    <span id="cart-total" class="cart-total">0.00 $</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase
        const SUPABASE_URL = 'https://uusnmuuysekydjtkkjjb.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1c25tdXV5c2VreWRqdGtrampiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0Mjc3MDksImV4cCI6MjA3OTAwMzcwOX0.6rRP22MpPe4QYL-Ibx-k764aS1AyT3X2OwSrytKU5sY';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, { auth: { persistSession:false, autoRefreshToken:false } });

        // State
        let allItems = [];
        let filteredItems = [];
        let weekGroups = {};
        let availableWeeks = [];
        let currentWeek = null;

        // Cart state
        let shoppingCart = JSON.parse(localStorage.getItem('grocery_cart')) || [];
        let userBudget = parseFloat(localStorage.getItem('grocery_budget')) || 100;

        // Week helpers
        function getISOWeek(date){ const d=new Date(date); d.setHours(0,0,0,0); d.setDate(d.getDate()+4-(d.getDay()||7)); const yearStart=new Date(d.getFullYear(),0,1); const weekNo=Math.ceil((((d-yearStart)/86400000)+1)/7); return {year:d.getFullYear(),week:weekNo}; }
        function formatWeekKey(year, week){ return `${year}-W${String(week).padStart(2,'0')}`; }
        function parseWeekKey(key){ const [y,w]=key.split('-W'); return {year:parseInt(y), week:parseInt(w)}; }
        function groupItemsByWeek(items){ const groups={}; items.forEach(it=>{ if(it.date){ const {year,week}=getISOWeek(it.date); const wk=formatWeekKey(year,week); if(!groups[wk]) groups[wk]=[]; groups[wk].push(it);} }); return groups; }
        function getMostRecentWeek(groups){ const weeks=Object.keys(groups).sort().reverse(); return weeks.length?weeks[0]:null; }

        // Normalized unit price for sorting and analytics (matches parentheses $/unit, $/100g, $/100ml)
        function getSortableUnitPrice(item){ if(!item.unit_price||!item.quantity||!item.unit) return null; const q=parseFloat(item.quantity), p=parseFloat(item.unit_price), u=String(item.unit).toLowerCase(); if(!q||!p) return null; if(u==='un') return p/q; if(u==='g') return (p/q)*100; if(u==='kg') return (p/q)/10; if(u==='ml') return (p/q)*100; if(u==='l') return (p/q)/10; return p/q; }

        function sortItems(items){ const v=document.getElementById('filter-sort').value; if(!v) return items; return items.sort((a,b)=>{ if(v==='price-asc') return (a.unit_price||0)-(b.unit_price||0); if(v==='price-desc') return (b.unit_price||0)-(a.unit_price||0); if(v==='unit-price-asc'){ const A=getSortableUnitPrice(a), B=getSortableUnitPrice(b); if(A==null && B==null) return 0; if(A==null) return 1; if(B==null) return -1; return A-B;} if(v==='unit-price-desc'){ const A=getSortableUnitPrice(a), B=getSortableUnitPrice(b); if(A==null && B==null) return 0; if(A==null) return 1; if(B==null) return -1; return B-A;} return 0; }); }

        // Populate filters
        function populateFilters(){ const stores=[...new Set(allItems.map(i=>i.store_name))].filter(Boolean).sort(); const cats=[...new Set(allItems.map(i=>i.categorie))].filter(Boolean).sort(); const storeContainer=document.getElementById('store-list-container'); storeContainer.innerHTML=''; stores.forEach(store=>{ const label=document.createElement('label'); label.className='store-checkbox-label'; const input=document.createElement('input'); input.type='checkbox'; input.name='store-select'; input.value=store; input.checked=true; input.addEventListener('change', filterItems); label.appendChild(input); label.appendChild(document.createTextNode(store)); storeContainer.appendChild(label); }); const catSel=document.getElementById('filter-category'); while(catSel.options.length>1) catSel.remove(1); cats.forEach(c=>{ const opt=document.createElement('option'); opt.value=c; opt.textContent=c; catSel.appendChild(opt); }); }


        // Unit price label
        function calculateUnitPrice(item){ if(!item.unit_price||!item.quantity||!item.unit) return ''; const q=parseFloat(item.quantity), p=parseFloat(item.unit_price), u=item.unit.toLowerCase(); if(u==='un'){ const v=p/q; return `<span style="font-size:12px;color:var(--color-text-secondary);">(${v.toFixed(2)} $/unit√©)</span>`;} if(u==='g'){ const v=(p/q)*100; return `<span style="font-size:12px;color:var(--color-text-secondary);">(${v.toFixed(2)} $/100g)</span>`;} if(u==='kg'){ const v=(p/q)/10; return `<span style="font-size:12px;color:var(--color-text-secondary);">(${v.toFixed(2)} $/100g)</span>`;} if(u==='ml'){ const v=(p/q)*100; return `<span style="font-size:12px;color:var(--color-text-secondary);">(${v.toFixed(2)} $/100ml)</span>`;} if(u==='l'){ const v=(p/q)/10; return `<span style="font-size:12px;color:var(--color-text-secondary);">(${v.toFixed(2)} $/100ml)</span>`;} const v=p/q; return `<span style="font-size:12px;color:var(--color-text-secondary);">(${v.toFixed(2)} $/${u})</span>`; }

        // Analytics helpers (true deal badge)
        function skuKey(item){ const name=(item.item||'').trim().toLowerCase(); const brand=(item.brand||'').trim().toLowerCase(); const qty=String(item.quantity||'').trim().toLowerCase(); const unit=(item.unit||'').trim().toLowerCase(); return `${name}__${brand}__${qty}${unit}`; }
        function normalizedUnitValue(item){ return getSortableUnitPrice(item); }
        let analyticsBySku=new Map();
        let historyBySku=new Map();
        function buildAnalytics(){ analyticsBySku=new Map(); historyBySku=new Map(); allItems.forEach(it=>{ const key=skuKey(it); const unitVal=normalizedUnitValue(it); if(unitVal==null) return; const dt=it.date?new Date(it.date):null; if(!historyBySku.has(key)) historyBySku.set(key,[]); historyBySku.get(key).push({unitVal,date:dt,item:it}); }); const now=new Date(), cutoff=new Date(now.getTime()-84*24*60*60*1000); historyBySku.forEach(arr=>{ arr.sort((a,b)=>(b.date||0)-(a.date||0)); const recent=arr.filter(r=>r.date&&r.date>=cutoff); if(recent.length>0){ arr.splice(0,arr.length,...recent); } }); historyBySku.forEach((arr,key)=>{ const values=arr.map(r=>r.unitVal).filter(v=>Number.isFinite(v)); if(values.length===0) return; const avg=values.reduce((a,b)=>a+b,0)/values.length; const min=Math.min(...values); const max=Math.max(...values); analyticsBySku.set(key,{avg,min,max,count:values.length}); }); }
        function computeDealInsights(item,currentWeekItems){ const key=skuKey(item); const ana=analyticsBySku.get(key); const val=normalizedUnitValue(item); if(!ana||val==null) return null; const pctVsAvg=((val-ana.avg)/ana.avg)*100; let bestCompetitor=null; if(Array.isArray(currentWeekItems)){ const sameSku=currentWeekItems.filter(it=>skuKey(it)===key); const best=sameSku.reduce((best,it)=>{ const v=normalizedUnitValue(it); if(v==null) return best; if(!best||v<best.v) return {v,store:it.store_name}; return best; },null); bestCompetitor=best; } const pctVsCompetitor=bestCompetitor&&bestCompetitor.v?((val-bestCompetitor.v)/bestCompetitor.v)*100:null; let lastTimeWeeks=null; const history=historyBySku.get(key)||[]; const ref=val; const similar=history.find(h=>Math.abs((h.unitVal-ref)/ref)<=0.02 && h.item.date && h.item.date!==item.date); if(similar&&similar.date){ const diff=Math.abs(new Date()-similar.date); lastTimeWeeks=Math.round(diff/(7*24*60*60*1000)); }
            const values=(history||[]).map(h=>h.unitVal).filter(v=>Number.isFinite(v)).sort((a,b)=>a-b);
            const rankCount=values.filter(v=>v<=val).length; const percentile=values.length?(rankCount/values.length)*100:100;
            let badge={cls:'badge-regular',label:'‚ö†Ô∏è PRIX HABITUEL/√âLEV√â'};
            if(percentile<=10) badge={cls:'badge-best',label:'üî• MEILLEUR PRIX HISTORIQUE'}; else if(percentile<=25) badge={cls:'badge-excellent',label:'‚úÖ EXCELLENT'}; else if(val<ana.avg) badge={cls:'badge-good',label:'üëç BON PRIX'};
            return {badge,pctVsAvg,pctVsCompetitor,lastTimeWeeks}; }

        // Chart.js
        let chartInstance=null;
        const storeColors={ 'Super C':'#EF4444','Maxi':'#3B82F6','IGA':'#F59E0B','Metro':'#10B981','Provigo':'#8B5CF6','Walmart':'#EC4899','default':'#6B7280' };
        function openHistoryModal(sku){ const history=historyBySku.get(sku); if(!history||history.length===0) return; const itemRef=history[0].item; const title=`${itemRef.item} ${itemRef.brand?'- '+itemRef.brand:''}`; const subtitle=`Historique pour ${itemRef.quantity} ${itemRef.unit}`; document.getElementById('modal-title').textContent=title; document.getElementById('modal-subtitle').textContent=subtitle; const storesMap={}; let minDate=new Date(); let maxDate=new Date(0); const allPrices=[]; history.forEach(h=>{ if(!h.item.date) return; const date=new Date(h.item.date); if(date<minDate) minDate=date; if(date>maxDate) maxDate=date; const store=h.item.store_name||'Autre'; if(!storesMap[store]) storesMap[store]=[]; const val=h.item.unit_price; allPrices.push(val); storesMap[store].push({x:date,y:val}); }); Object.values(storesMap).forEach(arr=>arr.sort((a,b)=>a.x-b.x)); allPrices.sort((a,b)=>a-b); const p25Index=Math.floor(allPrices.length*0.25); const p25Value=allPrices.length>0?allPrices[p25Index]:0; const bandStart=new Date(minDate); bandStart.setDate(bandStart.getDate()-7); const bandEnd=new Date(maxDate); bandEnd.setDate(bandEnd.getDate()+7); const datasets=[]; datasets.push({ label:'Zone Id√©ale (Top 25%)', data:[{x:bandStart,y:p25Value},{x:bandEnd,y:p25Value}], borderColor:'transparent', backgroundColor:'rgba(16,185,129,0.15)', borderWidth:0, pointRadius:0, fill:'start', order:99 }); Object.keys(storesMap).forEach(store=>{ const color=storeColors[store]||storeColors.default; datasets.push({label:store,data:storesMap[store],borderColor:color,backgroundColor:color,tension:0.1,pointRadius:5,pointHoverRadius:7,pointBackgroundColor:color,borderWidth:2}); }); const ctx=document.getElementById('priceChart').getContext('2d'); if(chartInstance) chartInstance.destroy(); chartInstance=new Chart(ctx,{ type:'line', data:{datasets}, options:{ responsive:true, maintainAspectRatio:false, interaction:{mode:'nearest',axis:'x',intersect:false}, plugins:{ legend:{position:'bottom',labels:{usePointStyle:true,boxWidth:10}}, tooltip:{callbacks:{ title:(ctx)=>{ const date=new Date(ctx[0].parsed.x); const {week}=getISOWeek(date); return `${date.toLocaleDateString('fr-CA')} (Semaine ${week})`; }, label:(ctx)=>{ if(ctx.dataset.label.includes('Zone Id√©ale')) return null; return `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(2)} $`; } } } }, scales:{ x:{ type:'time', time:{ unit:'week', tooltipFormat:'yyyy-MM-dd', displayFormats:{week:'d MMM'} }, title:{display:true,text:'Date'} }, y:{ title:{display:true,text:'Prix ($)'}, beginAtZero:true } } } }); document.getElementById('history-modal').classList.add('open'); }
        function closeHistoryModal(){ document.getElementById('history-modal').classList.remove('open'); }
        document.getElementById('history-modal').addEventListener('click',e=>{ if(e.target.id==='history-modal') closeHistoryModal(); });

        // Cart
        function addToCart(item){ const sku=skuKey(item); const existing=shoppingCart.find(i=>skuKey(i)===sku && i.store_name===item.store_name); if(existing){ alert('Cet article est d√©j√† dans votre liste !'); } else { shoppingCart.push(item); saveCart(); updateCartCount(); const btn=document.activeElement; if(btn){ const original=btn.innerHTML; btn.innerHTML='‚úÖ'; setTimeout(()=>btn.innerHTML=original, 1000); } } }
        function removeFromCart(index){ shoppingCart.splice(index,1); saveCart(); updateCartDisplay(); updateCartCount(); }
        function saveCart(){ localStorage.setItem('grocery_cart', JSON.stringify(shoppingCart)); localStorage.setItem('grocery_budget', userBudget); }
        function updateCartCount(){ document.getElementById('cart-count').textContent=shoppingCart.length; }
        function openCart(){ document.getElementById('cart-budget').value=userBudget; updateCartDisplay(); document.getElementById('cart-modal').classList.add('open'); }
        function closeCart(){ document.getElementById('cart-modal').classList.remove('open'); }
        document.getElementById('cart-modal').addEventListener('click',e=>{ if(e.target.id==='cart-modal') closeCart(); });
        function updateCartDisplay(){ const budgetInput=document.getElementById('cart-budget'); userBudget=parseFloat(budgetInput.value)||0; let total=0; let savings=0; const groupedByStore={}; shoppingCart.forEach((item,index)=>{ const store=item.store_name||'Autres'; if(!groupedByStore[store]) groupedByStore[store]=[]; groupedByStore[store].push({...item, originalIndex:index}); total += (item.unit_price||0); const key=skuKey(item); const ana=analyticsBySku.get(key); if(ana&&ana.avg&&item.unit_price){ const itemVal=normalizedUnitValue(item); if(itemVal && itemVal<ana.avg){ const factor=item.unit_price/itemVal; const saved=(ana.avg-itemVal)*factor; if(saved>0) savings+=saved; } } }); const container=document.getElementById('cart-items'); container.innerHTML=''; if(shoppingCart.length===0){ container.innerHTML='<p style="text-align:center; color: var(--color-text-secondary); margin-top:20px;">Votre liste est vide.</p>'; } else { Object.keys(groupedByStore).sort().forEach(store=>{ const storeDiv=document.createElement('div'); storeDiv.className='store-group'; storeDiv.innerHTML=`<div class="store-group-title">${store}</div>`; const byCat={}; groupedByStore[store].forEach(item=>{ const cat=item.categorie||'Divers'; if(!byCat[cat]) byCat[cat]=[]; byCat[cat].push(item); }); Object.keys(byCat).sort().forEach(cat=>{ const catDiv=document.createElement('div'); catDiv.className='category-group'; catDiv.innerHTML=`<div class="category-title">${cat}</div>`; byCat[cat].forEach(item=>{ const row=document.createElement('div'); row.className='cart-item'; row.innerHTML=`<div class="cart-item-info"><div class="cart-item-title">${item.item}</div><div class="cart-item-meta">${item.brand||''} ‚Ä¢ ${item.quantity} ${item.unit}</div></div><div class="cart-item-actions"><div class="cart-price">${item.unit_price.toFixed(2)}$</div><button class="remove-btn" onclick="removeFromCart(${item.originalIndex})">&times;</button></div>`; catDiv.appendChild(row); }); storeDiv.appendChild(catDiv); }); container.appendChild(storeDiv); }); }
            document.getElementById('cart-total').textContent=total.toFixed(2)+' $';
            document.getElementById('cart-savings').textContent=savings.toFixed(2)+' $';
            const warning=document.getElementById('budget-warning'); const totalEl=document.getElementById('cart-total'); if(userBudget>0 && total>userBudget){ warning.style.display='inline'; totalEl.style.color='#ef4444'; } else { warning.style.display='none'; totalEl.style.color='var(--color-text)'; }
            saveCart(); }

        // Display list (normal)
        function displayItems(items, currentWeekItems=null){ const container=document.getElementById('items-container'); if(items.length===0){ container.innerHTML='<p style="text-align:center; color: var(--color-text-secondary); grid-column:1/-1;">Aucune aubaine trouv√©e pour les crit√®res s√©lectionn√©s.</p>'; return; } container.innerHTML=items.map(item=>{ const insights=computeDealInsights(item, currentWeekItems||items)||null; let badgeHtml=''; let linesHtml=''; if(insights){ const vsAvg=isFinite(insights.pctVsAvg)?`${insights.pctVsAvg<0?'':'+'}${insights.pctVsAvg.toFixed(0)}% vs moyenne`:''; const vsComp=isFinite(insights.pctVsCompetitor)?`${insights.pctVsCompetitor<0?'':'+'}${insights.pctVsCompetitor.toFixed(0)}% vs meilleur concurrent`:''; const last=Number.isFinite(insights.lastTimeWeeks)?`Derni√®re fois √† ce prix : il y a ${insights.lastTimeWeeks} semaine${insights.lastTimeWeeks>1?'s':''}`:''; const parts=[vsAvg,vsComp].filter(Boolean).join('  |  '); const detail=[parts,last].filter(Boolean).join('\n'); badgeHtml=`<div class="deal-badge ${insights.badge.cls}">${insights.badge.label}</div>`; linesHtml=detail?`<div class="deal-insights"><div class="deal-line">${detail.replace(/\n/g,'<br>')}</div></div>`:''; }
            const sku=skuKey(item).replace(/['"\\]/g,'\\$&'); const itemJson=JSON.stringify(item).replace(/"/g,'&quot;');
            return `<div class="item-card"><button class="add-to-list-btn" onclick='addToCart(${itemJson})' title="Ajouter √† ma liste">+</button><div class="item-header"><div class="item-name">${item.item||'Sans nom'}</div>${item.categorie?`<div class="item-category">${item.categorie}</div>`:''}</div><div class="item-details">${item.brand?`<div class="detail-row"><span class="detail-label">Marque:</span><span class="detail-value">${item.brand}</span></div>`:''}${item.unit?`<div class="detail-row"><span class="detail-label">Unit√©:</span><span class="detail-value">${item.quantity||1} ${item.unit}</span></div>`:''}</div><div class="item-price">${item.unit_price?`<div style="display:flex; align-items:baseline; gap:8px;"><span style="font-size: var(--font-size-2xl); font-weight:600;">${item.unit_price.toFixed(2)} $</span>${calculateUnitPrice(item)}</div>${badgeHtml}${linesHtml}`:'Prix non disponible'}</div><div class="item-store"><span class="store-name">${item.store_name||'Magasin inconnu'}</span><span class="item-date">${item.date?new Date(item.date).toLocaleDateString('fr-CA'):''}</span></div><button class="view-history-btn" onclick="openHistoryModal('${sku}')">üìà Voir l'historique complet</button></div>`; }).join(''); }

        // Compact mode
        function compactGroups(items){ const groups=new Map(); for(const it of items){ const name=(it.item||'').trim().toLowerCase(); const brand=(it.brand||'').trim().toLowerCase(); const key=`${name}__${brand}`; if(!groups.has(key)) groups.set(key,[]); groups.get(key).push(it); } const compacted=[]; groups.forEach(arr=>{ if(arr.length===0) return; arr.sort((a,b)=>{ const ua=getSortableUnitPrice(a), ub=getSortableUnitPrice(b); if(ua!=null && ub!=null) return ua-ub; if(ua!=null) return -1; if(ub!=null) return 1; return (a.unit_price||Infinity)-(b.unit_price||Infinity); }); const best=arr[0]; const others=arr.slice(1).map(o=>{ const up=typeof o.unit_price==='number'?`${o.unit_price.toFixed(2)} $`:'N/D'; return `${o.store_name||'Magasin'}: ${up}`; }); compacted.push({best, others, all:arr}); }); return compacted; }
        function displayItemsCompact(items, currentWeekItems=null){ const container=document.getElementById('items-container'); if(!items||items.length===0){ container.innerHTML='<p style="text-align:center; color: var(--color-text-secondary); grid-column:1/-1;">Aucune aubaine trouv√©e pour les crit√®res s√©lectionn√©s.</p>'; return; } const groups=compactGroups(items); const sortVal=document.getElementById('filter-sort').value; groups.sort((A,B)=>{ const a=A.best,b=B.best; if(sortVal==='price-asc') return (a.unit_price||0)-(b.unit_price||0); if(sortVal==='price-desc') return (b.unit_price||0)-(a.unit_price||0); if(sortVal==='unit-price-asc'){ const va=getSortableUnitPrice(a), vb=getSortableUnitPrice(b); if(va==null&&vb==null) return 0; if(va==null) return 1; if(vb==null) return -1; return va-vb; } if(sortVal==='unit-price-desc'){ const va=getSortableUnitPrice(a), vb=getSortableUnitPrice(b); if(va==null&&vb==null) return 0; if(va==null) return 1; if(vb==null) return -1; return vb-va; } return 0; }); container.innerHTML=groups.map(g=>{ const item=g.best; const insights=computeDealInsights(item, currentWeekItems||items)||null; let badgeHtml=''; let linesHtml=''; if(insights){ const vsAvg=isFinite(insights.pctVsAvg)?`${insights.pctVsAvg<0?'':'+'}${insights.pctVsAvg.toFixed(0)}% vs moyenne`:''; const vsComp=isFinite(insights.pctVsCompetitor)?`${insights.pctVsCompetitor<0?'':'+'}${insights.pctVsCompetitor.toFixed(0)}% vs meilleur concurrent`:''; const last=Number.isFinite(insights.lastTimeWeeks)?`Derni√®re fois √† ce prix : il y a ${insights.lastTimeWeeks} semaine${insights.lastTimeWeeks>1?'s':''}`:''; const parts=[vsAvg,vsComp].filter(Boolean).join('  |  '); const detail=[parts,last].filter(Boolean).join('\n'); badgeHtml=`<div class="deal-badge ${insights.badge.cls}">${insights.badge.label}</div>`; linesHtml=detail?`<div class="deal-insights"><div class="deal-line">${detail.replace(/\n/g,'<br>')}</div></div>`:''; }
            const sku=skuKey(item).replace(/['"\\]/g,'\\$&'); const itemJson=JSON.stringify(item).replace(/"/g,'&quot;'); const othersHtml=g.others.length?`<div class="deal-insights" style="margin-top:6px;"><div class="deal-line"><strong>Autres enseignes:</strong> ${g.others.join(' ‚Ä¢ ')}</div></div>`:'';
            return `<div class="item-card"><button class="add-to-list-btn" onclick='addToCart(${itemJson})' title="Ajouter au meilleur prix">+</button><div class="item-header"><div class="item-name">${item.item||'Sans nom'}</div>${item.categorie?`<div class="item-category">${item.categorie}</div>`:''}</div><div class="item-details">${item.brand?`<div class="detail-row"><span class="detail-label">Marque:</span><span class="detail-value">${item.brand}</span></div>`:''}${item.unit?`<div class="detail-row"><span class="detail-label">Unit√©:</span><span class="detail-value">${item.quantity||1} ${item.unit}</span></div>`:''}</div><div class="item-price">${item.unit_price?`<div style="display:flex; align-items:baseline; gap:8px;"><span style="font-size: var(--font-size-2xl); font-weight:600;">${item.unit_price.toFixed(2)} $</span>${calculateUnitPrice(item)}</div>${badgeHtml}${linesHtml}${othersHtml}`:'Prix non disponible'}</div><div class="item-store"><span class="store-name">${item.store_name||'Magasin inconnu'}</span><span class="item-date">${item.date?new Date(item.date).toLocaleDateString('fr-CA'):''}</span></div><button class="view-history-btn" onclick="openHistoryModal('${sku}')">üìà Voir l'historique complet</button></div>`; }).join(''); }

        // Render dispatcher
        function renderList(items, currentWeekItems=null){ const compact=document.getElementById('compact-mode')?.checked; if(compact) displayItemsCompact(items, currentWeekItems); else displayItems(items, currentWeekItems); }

        // Display items for selected week
        function displayWeekItems(weekKey){ currentWeek=weekKey; const {week}=parseWeekKey(weekKey); document.getElementById('week-title').textContent=`Aubaines de la semaine ${week}`; const weekItems=weekGroups[weekKey]||[]; const categoryFilter=document.getElementById('filter-category').value.toLowerCase(); const searchFilter=document.getElementById('filter-search').value.toLowerCase(); const checkedStores=Array.from(document.querySelectorAll('input[name="store-select"]:checked')).map(cb=>cb.value); let filtered=weekItems.filter(item=>{ const matchStore=!item.store_name||checkedStores.includes(item.store_name); const matchCategory=!categoryFilter||(item.categorie&&item.categorie.toLowerCase()===categoryFilter); const matchSearch=!searchFilter||(item.item&&item.item.toLowerCase().includes(searchFilter))||(item.brand&&item.brand.toLowerCase().includes(searchFilter)); return matchStore&&matchCategory&&matchSearch; }); filteredItems=sortItems(filtered); renderList(filteredItems, weekItems); updateWeekSelector(); updateNavigationButtons(); }

        // Fetch
        async function fetchItems(){ try{ const {data,error}=await supabase.from('itemCirculaire').select('*').order('date',{ascending:false}); if(error) throw error; allItems=data; weekGroups=groupItemsByWeek(data); availableWeeks=Object.keys(weekGroups).sort().reverse(); buildAnalytics(); currentWeek=getMostRecentWeek(weekGroups); populateFilters(); if(currentWeek){ displayWeekItems(currentWeek); } else { const categoryFilter=document.getElementById('filter-category').value.toLowerCase(); const searchFilter=document.getElementById('filter-search').value.toLowerCase(); const checkedStores=Array.from(document.querySelectorAll('input[name="store-select"]:checked')).map(cb=>cb.value); let filtered=data.filter(item=>{ const matchStore=!item.store_name||checkedStores.includes(item.store_name); const matchCategory=!categoryFilter||(item.categorie&&item.categorie.toLowerCase()===categoryFilter); const matchSearch=!searchFilter||(item.item&&item.item.toLowerCase().includes(searchFilter))||(item.brand&&item.brand.toLowerCase().includes(searchFilter)); return matchStore&&matchCategory&&matchSearch; }); filteredItems=sortItems(filtered); renderList(filteredItems, data); } document.getElementById('loading').style.display='none'; } catch(err){ console.error('Erreur lors du chargement:', err); document.getElementById('loading').style.display='none'; document.getElementById('error-message').innerHTML=`<div class="error">Erreur lors du chargement des donn√©es: ${err.message}</div>`; } }

        // Events
        document.getElementById('filter-category').addEventListener('change', filterItems);
        document.getElementById('filter-sort').addEventListener('change', filterItems);
        document.getElementById('filter-search').addEventListener('input', filterItems);
        document.getElementById('compact-mode').addEventListener('change', filterItems);
        document.getElementById('week-selector').addEventListener('change', e=>{ if(e.target.value) displayWeekItems(e.target.value); });
        document.getElementById('prev-week').addEventListener('click',()=>{ const i=availableWeeks.indexOf(currentWeek); if(i<availableWeeks.length-1) displayWeekItems(availableWeeks[i+1]); });
        document.getElementById('next-week').addEventListener('click',()=>{ const i=availableWeeks.indexOf(currentWeek); if(i>0) displayWeekItems(availableWeeks[i-1]); });

        function updateWeekSelector(){ const sel=document.getElementById('week-selector'); sel.innerHTML=''; availableWeeks.forEach(weekKey=>{ const {year,week}=parseWeekKey(weekKey); const opt=document.createElement('option'); opt.value=weekKey; opt.textContent=`Semaine ${week} de ${year}`; sel.appendChild(opt); }); if(currentWeek) sel.value=currentWeek; }
        function updateNavigationButtons(){ const idx=availableWeeks.indexOf(currentWeek); const prev=document.getElementById('prev-week'); const next=document.getElementById('next-week'); prev.disabled=idx>=availableWeeks.length-1; prev.style.opacity=prev.disabled?'0.5':'1'; prev.style.cursor=prev.disabled?'not-allowed':'pointer'; next.disabled=idx<=0; next.style.opacity=next.disabled?'0.5':'1'; next.style.cursor=next.disabled?'not-allowed':'pointer'; }

        function filterItems(){ if(currentWeek){ displayWeekItems(currentWeek); } else { const categoryFilter=document.getElementById('filter-category').value.toLowerCase(); const searchFilter=document.getElementById('filter-search').value.toLowerCase(); const checkedStores=Array.from(document.querySelectorAll('input[name="store-select"]:checked')).map(cb=>cb.value); let filtered=allItems.filter(item=>{ const matchStore=!item.store_name||checkedStores.includes(item.store_name); const matchCategory=!categoryFilter||(item.categorie&&item.categorie.toLowerCase()===categoryFilter); const matchSearch=!searchFilter||(item.item&&item.item.toLowerCase().includes(searchFilter))||(item.brand&&item.brand.toLowerCase().includes(searchFilter)); return matchStore&&matchCategory&&matchSearch; }); filteredItems=sortItems(filtered); renderList(filteredItems, allItems); } }

        // Init
        updateCartCount();
        fetchItems();
    </script>
</body>
</html>